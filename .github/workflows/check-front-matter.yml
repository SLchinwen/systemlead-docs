name: Check Markdown Front-matter (MVP)

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  check-front-matter:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Get changed Markdown files
        run: |
          git fetch origin ${{ github.base_ref }}
          git diff --name-only origin/${{ github.base_ref }}...HEAD \
            | grep '\.md$' > changed_md_files.txt || true

      - name: Validate front-matter
        run: |
          REQUIRED_FIELDS=("docType" "product" "audience" "status")
          FAILED=0

          if [ ! -s changed_md_files.txt ]; then
            echo "No Markdown files changed."
            exit 0
          fi

          while read -r file; do
            echo "üîç Checking $file"

            # Skip deleted files
            if [ ! -f "$file" ]; then
              continue
            fi

            # Check front-matter existence (must start with ---)
            if ! sed -n '1,5p' "$file" | grep -q '^---$'; then
              echo "‚ùå $file: missing YAML front-matter start '---'"
              FAILED=1
              continue
            fi

            # Extract front-matter block between first and second ---
            FRONT_MATTER=$(awk '
              NR==1 && $0=="---" {in=1; next}
              in && $0=="---" {exit}
              in {print}
            ' "$file")

            if [ -z "$FRONT_MATTER" ]; then
              echo "‚ùå $file: front-matter block is empty or missing closing '---'"
              FAILED=1
              continue
            fi

            for field in "${REQUIRED_FIELDS[@]}"; do
              if ! echo "$FRONT_MATTER" | grep -q "^$field:"; then
                echo "‚ùå $file: missing required field '$field'"
                FAILED=1
              fi
            done

          done < changed_md_files.txt

          if [ "$FAILED" -ne 0 ]; then
            echo ""
            echo "üö´ Front-matter validation failed."
            echo "Required fields: docType, product, audience, status"
            exit 1
          fi

          echo "‚úÖ Front-matter validation passed."
